<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modulo Iscrizione Corsi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        :root { 
            --primary:#3498db;--primary-light:#e7f2fa;--primary-dark:#2980b9;
            --success:#2ecc71;--success-dark:#27ae60;
            --danger:#e74c3c;
            --warning:#f39c12;--warning-dark:#e67e22;
            --gray-light:#f8f9fa;--gray:#95a5a6;--dark:#2c3e40;
            --border-radius:12px;
        }
        body {font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;min-height:100vh;background:linear-gradient(135deg,#f0f4ff,#d9e6ff);display:flex;flex-direction:column;color:var(--dark);}
        .container {flex:1;width:100%;max-width:500px;margin:0 auto;padding:1rem;display:flex;flex-direction:column;}
        .header {background:var(--primary);color:white;padding:1rem;text-align:center;position:sticky;top:0;z-index:10;box-shadow:0 2px 10px rgba(0,0,0,0.1);}
        .header h1 {font-size:1.4rem;font-weight:600;margin:0;}
        .card {background:white;border-radius:var(--border-radius);box-shadow:0 4px 15px rgba(0,0,0,0.1);padding:1.5rem;margin-bottom:1rem;width:100%;}
        h2 {color:var(--primary);margin-bottom:1.2rem;text-align:center;font-size:1.4rem;}
        .form-group {margin-bottom:1.5rem;}
        label {display:block;margin-bottom:0.5rem;font-weight:500;font-size:1rem;}
        input, select {width:100%;padding:1rem;font-size:1rem;border-radius:var(--border-radius);border:1px solid #ddd;background-color:var(--gray-light);}
        input:focus, select:focus {border-color:var(--primary);outline:none;box-shadow:0 0 0 3px rgba(52,152,219,0.25);}
        .btn {display:block;width:100%;padding:1rem;font-size:1.1rem;font-weight:600;border-radius:var(--border-radius);border:none;text-align:center;cursor:pointer;transition:all 0.2s ease;margin-top:1rem;}
        .btn-primary {background:var(--primary);color:white;}
        .btn-success {background:var(--success);color:white;}
        .btn-warning {background:var(--warning);color:white;}
        .btn-danger {background:var(--danger);color:white;}
        .error-message {color:var(--danger);font-size:0.9rem;margin-top:0.5rem;display:none;}
        .loading {display:none;text-align:center;margin:1rem 0;color:var(--primary);}
        .hidden {display:none;}
        .center {text-align:center;}
        .success-icon {font-size:4rem;margin-bottom:1.5rem;color:var(--success);}
        .footer {text-align:center;padding:1rem;color:var(--gray);font-size:0.9rem;margin-top:auto;}
        .corsi-container {display:grid;grid-template-columns:1fr;gap:0.8rem;margin-bottom:1rem;}
        .corso-option {display:flex;align-items:center;padding:1rem;border:2px solid #ddd;border-radius:var(--border-radius);cursor:pointer;transition:all 0.2s ease;background:white;}
        .corso-option:hover {border-color:var(--primary);background-color:var(--primary-light);}
        .corso-option.selected {border-color:var(--primary);background-color:var(--primary-light);}
        .corso-option.disabled {opacity:0.6;cursor:not-allowed;}
        .status-message {text-align:center;padding:1rem;color:var(--gray);font-style:italic;}
        
        .categoria-label {
            background-color: var(--primary-light);
            padding: 0.8rem 1rem;
            border-radius: var(--border-radius);
            margin-top: 1rem;
            margin-bottom: 1rem;
            font-weight: bold;
            color: var(--primary-dark);
            text-align: center;
        }
        .corso-categoria {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 0.3rem;
        }
        .badge {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }
        .badge-biennio {
            background-color: var(--primary-light);
            color: var(--primary-dark);
        }
        .badge-triennio {
            background-color: var(--success);
            color: white;
        }
        .badge-universitari {
            background-color: var(--warning);
            color: white;
        }
        .badge-tutti {
            background-color: var(--gray);
            color: white;
        }
        
        .error-box {
            background-color: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            text-align: center;
            display: none;
        }
        
        .info-box {
            background-color: #e3f2fd;
            color: #1565c0;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="header"><h1>Iscrizione Corsi</h1></div>
    <div class="container">
        <div class="info-box">
            <i class="fas fa-info-circle"></i> Compila il modulo per iscriverti a uno dei corsi disponibili
        </div>

        <div class="error-box" id="errorGeneral">
            <i class="fas fa-exclamation-circle"></i> <span id="errorText"></span>
        </div>

        <!-- STEP 1 -->
        <div id="step1" class="card">
            <h2>Dati personali</h2>
            <div class="form-group">
                <label for="nome">Nome</label>
                <input type="text" id="nome" placeholder="Il tuo nome" required>
                <div class="error-message" id="error-nome">Inserisci un nome valido</div>
            </div>
            <div class="form-group">
                <label for="cognome">Cognome</label>
                <input type="text" id="cognome" placeholder="Il tuo cognome" required>
                <div class="error-message" id="error-cognome">Inserisci un cognome valido</div>
            </div>
            <div class="form-group">
                <label for="anno">Anno di nascita</label>
                <input type="number" id="anno" min="1900" max="2025" placeholder="Es: 2005" required>
                <div class="error-message" id="error-anno">Inserisci un anno valido (1900-2025)</div>
            </div>
            <button id="btnAvanti" class="btn btn-primary">Avanti</button>
        </div>

        <!-- STEP 2 -->
        <div id="step2" class="card hidden">
            <h2>Seleziona un corso</h2>
            <div id="categoriaInfo" class="categoria-label"></div>
            <div class="corsi-container" id="corsiContainer"></div>
            <div id="corsiStatus" class="status-message">Caricamento corsi in corso...</div>
            <input type="hidden" id="corsoSelezionato">
            <div class="error-message" id="error-corso">Seleziona un corso</div>
            <div class="loading" id="loadingIscrizione">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Elaborazione in corso...</p>
            </div>
            <button id="btnIscriviti" class="btn btn-primary">Iscriviti</button>
            <button id="btnIndietro" class="btn" style="background: var(--gray-light); color: var(--dark); margin-top: 0.5rem;">Indietro</button>
        </div>

        <!-- STEP 3 -->
        <div id="conferma" class="card center hidden">
            <div class="success-icon">✅</div>
            <h2>Iscrizione Completata!</h2>
            <p>Grazie <strong id="nomeConferma"></strong> per esserti iscritto al corso <strong id="corso-conferma"></strong>.</p>
            <div class="button-group">
                <button class="btn btn-success" id="btnChiudiScheda">Chiudi Scheda</button>
            </div>
        </div>

        <div class="footer"><p>© 2023 - Tutti i diritti riservati</p></div>
    </div>

    <script>
        // Sostituisci con il tuo URL di Google Apps Script
        const scriptURL = "https://script.google.com/macros/s/AKfycbziZIDZtpVXqWqs-74i1lvRcsQtdaU5HsyXTjb56NfH3PjrcYbj3Jch9-cn-9U2U7X95A/exec";

        // elementi
        const step1 = document.getElementById("step1");
        const step2 = document.getElementById("step2");
        const confermaDiv = document.getElementById("conferma");
        const btnAvanti = document.getElementById("btnAvanti");
        const btnIscriviti = document.getElementById("btnIscriviti");
        const btnIndietro = document.getElementById("btnIndietro");
        const btnNuovaIscrizione = document.getElementById("btnNuovaIscrizione");
        const btnChiudiScheda = document.getElementById("btnChiudiScheda");
        const corsiContainer = document.getElementById("corsiContainer");
        const corsiStatus = document.getElementById("corsiStatus");
        const corsoSelezionatoInput = document.getElementById("corsoSelezionato");
        const corsoConferma = document.getElementById("corso-conferma");
        const nomeConferma = document.getElementById("nomeConferma");
        const loadingIscrizione = document.getElementById("loadingIscrizione");
        const categoriaInfo = document.getElementById("categoriaInfo");
        const errorGeneral = document.getElementById("errorGeneral");
        const errorText = document.getElementById("errorText");

        let nome = "", cognome = "", anno = "", categoria = "";

        // Funzione per mostrare errori
        function showError(message) {
            errorText.textContent = message;
            errorGeneral.style.display = 'block';
            setTimeout(() => {
                errorGeneral.style.display = 'none';
            }, 5000);
        }

        // STEP 1 -> STEP 2
        btnAvanti.addEventListener("click", () => {
            nome = document.getElementById("nome").value.trim();
            cognome = document.getElementById("cognome").value.trim();
            anno = document.getElementById("anno").value.trim();
            const year = parseInt(anno);
            
            // Validazione
            if (!nome) {
                showError("Inserisci il tuo nome");
                return;
            }
            
            if (!cognome) {
                showError("Inserisci il tuo cognome");
                return;
            }
            
            const currentYear = new Date().getFullYear();
            if (isNaN(year) || year < 1900 || year > currentYear) {
                showError("Inserisci un anno di nascita valido");
                return;
            }
            
            // Calcola l'età
            const age = currentYear - year;
            
            // CORREZIONE: Determinazione corretta della categoria in base all'anno di nascita
            // Biennio: nati dal 2011 al 2010
            // Triennio: nati dal 2009 al 2007
            // Universitari: nati nel 2006 e precedenti
            if (year >= 2011 || year === 2010) {
                categoria = "biennio";
            } else if (year >= 2007 && year <= 2009) {
                categoria = "triennio";
            } else {
                categoria = "universitari";
            }
            
            step1.classList.add("hidden");
            step2.classList.remove("hidden");
            categoriaInfo.textContent = `Categoria: ${categoria.toUpperCase()} (${age} anni)`;
            caricaCorsi();
        });

        // Torna indietro
        btnIndietro.addEventListener("click", () => {
            step2.classList.add("hidden");
            step1.classList.remove("hidden");
            errorGeneral.style.display = 'none';
        });

        // CARICAMENTO CORSI
        function caricaCorsi() {
            corsiContainer.innerHTML = "";
            corsiStatus.style.display = "block";
            
            fetch(scriptURL)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Errore nel caricamento dei corsi');
                    }
                    return response.json();
                })
                .then(corsi => {
                    corsiStatus.style.display = "none";
                    
                    if (!corsi || corsi.length === 0) {
                        corsiContainer.innerHTML = `<div class="status-message">Nessun corso disponibile al momento.</div>`;
                        return;
                    }
                    
                    // Filtra i corsi per categoria
                    const corsiFiltrati = corsi.filter(c => {
                        if (c && c.length >= 3) {
                            const corsoCategoria = c[2] ? c[2].toLowerCase().trim() : "";
                            return corsoCategoria === categoria || corsoCategoria === "tutti";
                        }
                        return false;
                    });
                    
                    if (corsiFiltrati.length === 0) {
                        corsiContainer.innerHTML = `<div class="status-message">Nessun corso disponibile per la categoria ${categoria} al momento.</div>`;
                        return;
                    }
                    
                    corsiFiltrati.forEach(c => {
                        if (c && c.length >= 2) {
                            let nomeCorso = c[0];
                            let posti = Number(c[1]);
                            let corsoCategoria = c[2] || "tutti";
                            
                            const div = document.createElement("div");
                            div.className = "corso-option";
                            if (posti <= 0) {
                                div.classList.add("disabled");
                            }
                            
                            // Aggiungi badge per la categoria del corso
                            let badgeClass = "badge-tutti";
                            if (corsoCategoria === "biennio") badgeClass = "badge-biennio";
                            else if (corsoCategoria === "triennio") badgeClass = "badge-triennio";
                            else if (corsoCategoria === "universitari") badgeClass = "badge-universitari";
                            
                            div.innerHTML = `
                                <div style="flex-grow:1">
                                    <div class="corso-titolo">${nomeCorso} <span class="badge ${badgeClass}">${corsoCategoria.toUpperCase()}</span></div>
                                    <div class="corso-posti">${posti > 0 ? posti + " posti disponibili" : "Posti esauriti"}</div>
                                </div>
                            `;
                            
                            if (posti > 0) {
                                div.addEventListener("click", () => {
                                    document.querySelectorAll(".corso-option").forEach(o => o.classList.remove("selected"));
                                    div.classList.add("selected");
                                    corsoSelezionatoInput.value = nomeCorso;
                                });
                            }
                            
                            corsiContainer.appendChild(div);
                        }
                    });
                })
                .catch(error => {
                    console.error('Errore:', error);
                    corsiStatus.textContent = "Errore nel caricamento dei corsi. Riprova più tardi.";
                });
        }

        // ISCRIZIONE
        btnIscriviti.addEventListener("click", () => {
            if (!corsoSelezionatoInput.value) {
                showError("Seleziona un corso!");
                return;
            }
            
            loadingIscrizione.style.display = "block";
            btnIscriviti.disabled = true;
            
            const dati = new URLSearchParams();
            dati.append("nome", nome);
            dati.append("cognome", cognome);
            dati.append("anno", anno);
            dati.append("corso", corsoSelezionatoInput.value);
            dati.append("categoria", categoria);

            fetch(scriptURL, { 
                method: "POST", 
                body: dati 
            })
                .then(response => response.text())
                .then(resp => {
                    loadingIscrizione.style.display = "none";
                    btnIscriviti.disabled = false;
                    
                    if (resp === "OK") {
                        step2.classList.add("hidden");
                        confermaDiv.classList.remove("hidden");
                        nomeConferma.textContent = nome;
                        corsoConferma.textContent = corsoSelezionatoInput.value;
                    } else if (resp === "FULL") {
                        showError("Posti esauriti per questo corso! Scegli un altro corso.");
                        caricaCorsi();
                    } else if (resp === "DUPLICATO") {
                        showError("Sei già iscritto a un corso! Non puoi iscriverti più volte.");
                    } else {
                        showError("Errore durante l'iscrizione! Riprova più tardi.");
                    }
                })
                .catch(error => {
                    console.error('Errore:', error);
                    loadingIscrizione.style.display = "none";
                    btnIscriviti.disabled = false;
                    showError("Errore di connessione. Riprova più tardi.");
                });
        });

        // Chiudi scheda
        btnChiudiScheda.addEventListener("click", () => {
            window.close();
        });
    </script>
</body>
</html>